# coding=utf-8

# This file was *autogenerated* from the file script2.sage
from sage.all_cmdline import *   # import sage library

_sage_const_2 = Integer(2); _sage_const_1 = Integer(1); _sage_const_256 = Integer(256); _sage_const_16 = Integer(16); _sage_const_2049 = Integer(2049)#!/usr/bin/env sage

from pubkey import P, n, e
from secret import flag
from os import urandom

R = GF(_sage_const_2 **_sage_const_2049 , names=('a',)); (a,) = R._first_ngens(1)

def private_key(e, l):
    counter = _sage_const_1 
    while True:
        if e * P(R.fetch_int(counter)) % l == _sage_const_1 :
            return P(R.fetch_int(counter))
            

def lcm(p, q):
    return p * q / gcd(p, q)

def encrypt(m):
    global n
    assert len(m) <= _sage_const_256 
    m_int = Integer(m.encode('hex'), _sage_const_16 )
    m_poly = P(R.fetch_int(m_int))
    c_poly = pow(m_poly, e, n)
    c_int = R(c_poly).integer_representation()
    c = format(c_int, '0256x').decode('hex')

    p_poly, q_poly = factor(n)

    p_poly = P(p_poly)
    q_poly = P(q_poly)
    e_poly = P(R.fetch_int(e))
    l_poly = P((p_poly - _sage_const_1 ) * (q_poly - _sage_const_1 ))
    d_poly = private_key(e_poly, l_poly)

    print(d_poly)

    d_int = R(d_poly).integer_representation()

    print(d_int)

    return c

if __name__ == '__main__':
    ptext = flag + os.urandom(_sage_const_256 -len(flag))
    ctext = encrypt(ptext)
    with open('flag2.enc', 'wb') as f:
        f.write(ctext)

